:; #-*- mode: nendo; syntax: scheme -*-;;
;;;
;;; roman-lib.nnd - ローマ字と平仮名、片仮名の相互変換ライブラリ
;;;  
;;;   Copyright (c) 2010  Kiyoka Nishiyama  <kiyoka@sumibi.org>
;;;   
;;;   Redistribution and use in source and binary forms, with or without
;;;   modification, are permitted provided that the following conditions
;;;   are met:
;;;   
;;;   1. Redistributions of source code must retain the above copyright
;;;      notice, this list of conditions and the following disclaimer.
;;;  
;;;   2. Redistributions in binary form must reproduce the above copyright
;;;      notice, this list of conditions and the following disclaimer in the
;;;      documentation and/or other materials provided with the distribution.
;;;  
;;;   3. Neither the name of the authors nor the names of its contributors
;;;      may be used to endorse or promote products derived from this
;;;      software without specific prior written permission.
;;;  
;;;   THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
;;;   "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
;;;   LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
;;;   A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
;;;   OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
;;;   SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
;;;   TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
;;;   PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
;;;   LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
;;;   NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
;;;   SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
;;;  
;;;  $Id: 
;;;
(use srfi-1)

;; 子音が1音だけ入ったテーブル
;; このテーブルはruby-romkan から変換し、一部不足を追加した。
;;  クンレイ、日本式、ヘボン式もデータ中に併記し全てを網羅している。
(define sekka-kana->roman-alist-short
  '(
    ;; normal roman                                ---AZIK---
    ("ぁ"                                            "la")
    ("あ"        "a")
    ("ぃ"                                            "li")
    ("い"        "i")
    ("ぅ"                                            "lu")
    ("う"        "u")
    ("う゛"      "vu")
    ("う゛ぁ"    "va")
    ("う゛ぃ"    "vi")
    ("う゛ぇ"    "ve")
    ("う゛ぉ"    "vo")
    ("ぇ"                                            "le")
    ("え"        "e")
    ("ぉ"                                            "lo")
    ("お"        "o")
    ("か"        "ka")
    ("が"        "ga")
    ("き"        "ki")
    ("きゃ"      "kya"                               "kga")
    ("きゅ"      "kyu"                               "kgu")
    ("きぇ"      "kye"                               "kge")
    ("きょ"      "kyo"                               "kgo")
    ("ぎ"        "gi")
    ("ぎゃ"      "gya")
    ("ぎゅ"      "gyu")
    ("ぎぇ"      "gye")
    ("ぎょ"      "gyo")
    ("く"        "ku")
    ("ぐ"        "gu")
    ("け"        "ke")
    ("げ"        "ge")
    ("こ"        "ko")
    ("ご"        "go")
    ("さ"        "sa")
    ("ざ"        "za"                                "zc")    ;; AZIKザ行の特別措置
    ("し"        "shi"                               "si")
    ("しゃ"      "sha" "sya"                         "xa")
    ;; hu の例外処理: shu は sfu になってはいけない
    ("しゅ"      "shu" "syu"                         "xu")
    ("しぇ"      "she" "sye"                         "xe")
    ("しょ"      "sho" "syo"                         "xo")
    ("じ"        "ji" "zi")
    ("じゃ"      "ja" "jya"                          "zya")
    ("じゅ"      "ju" "jyu"                          "zyu")
    ("じぇ"      "je" "jye"                          "zye")
    ("じょ"      "jo" "jyo"                          "zyo")
    ("す"        "su")
    ("ず"        "zu")
    ("せ"        "se")
    ("ぜ"        "ze")
    ("そ"        "so")
    ("ぞ"        "zo")
    ("た"        "ta")
    ("だ"        "da")
    ;; normal roman                                ---AZIK---
    ("ち"        "chi" "tyi"                         "ti")
    ("ちゃ"      "cha" "tya"                         "ca")
    ;; hu の例外処理: chu は cfu になってはいけない
    ("ちゅ"      "chu" "tyu"                         "cu")
    ("ちぇ"      "che" "tye"                         "ce")
    ("ちょ"      "cho" "tyo"                         "co")
    ("ぢ"        "di")
    ("ぢゃ"      "dya")
    ("ぢゅ"      "dyu")
    ("ぢぇ"      "dye")
    ("ぢょ"      "dyo")
    ("っ"        "tt"                                 "@" "ltu")
    ;; normal roman                                ---AZIK---
    ("つ"        "tsu"                                "tu")
    ("づ"        "du")
    ("て"        "te")
    ("で"        "de")
    ("と"        "to")
    ("ど"        "do")
    ("な"        "na")
    ("に"        "ni")
    ("にゃ"      "nya")
    ("にゅ"      "nyu")
    ("にぇ"      "nye")
    ("にょ"      "nyo")
    ("ぬ"        "nu")
    ("ね"        "ne")
    ("の"        "no")
    ("は"        "ha")
    ("ば"        "ba")
    ("ぱ"        "pa")
    ("ひ"        "hi")
    ("ひゃ"      "hya"                                "hga")
    ("ひゅ"      "hyu"                                "hgu")
    ("ひぇ"      "hye"                                "hge")
    ("ひょ"      "hyo"                                "hgo")
    ("び"        "bi")
    ("びゃ"      "bya")
    ("びゅ"      "byu")
    ("びぇ"      "bye")
    ("びょ"      "byo")
    ("ぴ"        "pi")
    ("ぴゃ"      "pya"                                "pga")
    ("ぴゅ"      "pyu"                                "pgu")
    ("ぴぇ"      "pye"                                "pge")
    ("ぴょ"      "pyo"                                "pgo")
    ("ふ"        "fu" "hu")
    ("ふぁ"      "fa")
    ("ふぃ"      "fi")
    ("ふぇ"      "fe")
    ("ふぉ"      "fo")
    ("ぶ"        "bu")
    ("ぷ"        "pu")
    ("へ"        "he")
    ("べ"        "be")
    ("ぺ"        "pe")
    ("ほ"        "ho")
    ("ぼ"        "bo")
    ("ぽ"        "po")
    ("ま"        "ma")
    ("み"        "mi")
    ("みゃ"      "mya"                                 "mga")
    ("みゅ"      "myu"                                 "mgu")
    ("みぇ"      "mye"                                 "mge")
    ("みょ"      "myo"                                 "mgo")
    ("む"        "mu")
    ("め"        "me")
    ("も"        "mo")
    ;; normal roman                                ---AZIK---
    ("ゃ"                                             "lya")
    ("や"        "ya")
    ("ゅ"                                             "lyu")
    ("ゆ"        "yu")
    ("ょ"                                             "lyo")
    ("よ"        "yo")
    ("ら"        "ra")
    ("り"        "ri")
    ("りゃ"      "rya")
    ("りゅ"      "ryu")
    ("りょ"      "ryo")
    ("る"        "ru")
    ("れ"        "re")
    ("ろ"        "ro")
    ("ゎ"                                             "lwa")
    ("わ"        "wa")
    ("うぃ"      "wi")
    ("うぇ"      "we")
    ("を"        "wo")
    ("うぉ"      "wso")
    ;; normal roman                                ---AZIK---
    ("ん"        "nn" "n"                             "q")
    ("でぃ"      "dyi" "dhi"                          "dci")
    ("でぅ"      "dyu" "dhu"                          "dcu")
    ("ー"        "-" "^"                              ":")

    ;; Ruby romkanからの不足分追加
    ("てぃ"     "thi"                                 "tgi")
    ("てぅ"     "thu"                                 "tgu")
    ;; Sekkaの辞書に入っている特別なキーワード ">あん" など
    (">"        ">")

    ;; 撥音から始まるキーワード
    ("っう゛"    "vvu"                                "@vu")
    ("っう゛ぁ"  "vva"                                "@va" )
    ("っう゛ぃ"  "vvi"                                "@vi" )
    ("っう゛ぇ"  "vve"                                "@ve" )
    ("っう゛ぉ"  "vvo"                                "@vo" )
    ("っか"      "kka"                                "@ka" )
    ("っが"      "gga"                                "@ga" )
    ("っき"      "kki"                                "@ki" )
    ("っきゃ"    "kkya"                               "@kya")
    ("っきゅ"    "kkyu"                               "@kyu")
    ("っきぇ"    "kkye"                               "@kye")
    ("っきょ"    "kkyo"                               "@kyo")
    ("っぎ"      "ggi"                                "@gi" )
    ("っぎゃ"    "ggya"                               "@gya")
    ("っぎゅ"    "ggyu"                               "@gyu")
    ("っぎぇ"    "ggye"                               "@gye")
    ("っぎょ"    "ggyo"                               "@gyo")
    ("っく"      "kku"                                "@ku" )
    ("っぐ"      "ggu"                                "@gu" )
    ("っけ"      "kke"                                "@ke" )
    ("っげ"      "gge"                                "@ge" )
    ("っこ"      "kko"                                "@ko" )
    ("っご"      "ggo"                                "@go" )
    ("っさ"      "ssa"                                "@sa" )
    ("っざ"      "zza"                                "@za" )
    ("っし"      "sshi"  "sshi"                       "@shi"   "@shi")
    ("っしゃ"    "ssha"  "ssya"                       "@sha"   "@sya")
    ("っしゅ"    "sshu"  "ssyu"                       "@shu"   "@syu")
    ("っしぇ"    "sshe"  "ssye"                       "@she"   "@sye")
    ("っしょ"    "ssho"  "ssyo"                       "@sho"   "@syo")
    ("っじ"      "jji"                                "@ji" )
    ("っじゃ"    "jja"                                "@ja" )
    ("っじゅ"    "jju"                                "@ju" )
    ("っじぇ"    "jje"                                "@je" )
    ("っじょ"    "jjo"                                "@jo" )
    ("っす"      "ssu"                                "@su" )
    ("っず"      "zzu"                                "@zu" )
    ("っせ"      "sse"                                "@se" )
    ("っぜ"      "zze"                                "@ze" )
    ("っそ"      "sso"                                "@so" )
    ("っぞ"      "zzo"                                "@zo" )
    ("った"      "tta"                                "@ta" )
    ("っだ"      "dda"                                "@da" )
    ("っち"      "cchi"  "ttyi"  "cci"                "@chi"  "@tyi"  "@ci")
    ("っちゃ"    "ccha"  "ttya"  "cca"                "@cha"  "@tya"  "@ca")
    ("っちゅ"    "cchu"  "ttyu"  "ccu"                "@chu"  "@tyu"  "@cu")
    ("っちぇ"    "cche"  "ttye"  "cce"                "@che"  "@tye"  "@ce")
    ("っちょ"    "ccho"  "ttyo"  "cco"                "@cho"  "@tyo"  "@co")
    ("っぢ"      "ddi"                                "@di" )
    ("っぢゃ"    "ddya"                               "@dya")
    ("っぢゅ"    "ddyu"                               "@dyu")
    ("っぢぇ"    "ddye"                               "@dye")
    ("っぢょ"    "ddyo"                               "@dyo")
    ("っつ"      "ttsu"                               "@tsu")
    ("っづ"      "ddu"                                "@du" )
    ("って"      "tte"                                "@te" )
    ("っで"      "dde"                                "@de" )
    ("っと"      "tto"                                "@to" )
    ("っど"      "ddo"                                "@do" )
    ("っは"      "hha"                                "@ha" )
    ("っば"      "bba"                                "@ba" )
    ("っぱ"      "ppa"                                "@pa" )
    ("っひ"      "hhi"                                "@hi" )
    ("っひゃ"    "hhya"                               "@hya")
    ("っひゅ"    "hhyu"                               "@hyu")
    ("っひぇ"    "hhye"                               "@hye")
    ("っひょ"    "hhyo"                               "@hyo")
    ("っび"      "bbi"                                "@bi" )
    ("っびゃ"    "bbya"                               "@bya")
    ("っびゅ"    "bbyu"                               "@byu")
    ("っびぇ"    "bbye"                               "@bye")
    ("っびょ"    "bbyo"                               "@byo")
    ("っぴ"      "ppi"                                "@pi" )
    ("っぴゃ"    "ppya"                               "@pya")
    ("っぴゅ"    "ppyu"                               "@pyu")
    ("っぴぇ"    "ppye"                               "@pye")
    ("っぴょ"    "ppyo"                               "@pyo")
    ("っふ"      "ffu"    "hhu"                       "@fu"    "@hu")
    ("っふぁ"    "ffa"                                "@fa" )
    ("っふぃ"    "ffi"                                "@fi" )
    ("っふぇ"    "ffe"                                "@fe" )
    ("っふぉ"    "ffo"                                "@fo" )
    ("っぶ"      "bbu"                                "@bu" )
    ("っぷ"      "ppu"                                "@pu" )
    ("っへ"      "hhe"                                "@he" )
    ("っべ"      "bbe"                                "@be" )
    ("っぺ"      "ppe"                                "@pe" )
    ("っほ"      "hho"                                "@ho" )
    ("っぼ"      "bbo"                                "@bo" )
    ("っぽ"      "ppo"                                "@po" )
    ("っや"      "yya"                                "@ya" )
    ("っゆ"      "yyu"                                "@yu" )
    ("っよ"      "yyo"                                "@yo" )
    ("っら"      "rra"                                "@ra" )
    ("っり"      "rri"                                "@ri" )
    ("っりゃ"    "rrya"                               "@rya")
    ("っりゅ"    "rryu"                               "@ryu")
    ("っりぇ"    "rrye"                               "@rye")
    ("っりょ"    "rryo"                               "@ryo")
    ("っる"      "rru"                                "@ru" )
    ("っれ"      "rre"                                "@re" )
    ("っろ"      "rro"                                "@ro" )
    ))

;; 子音が2音入ったテーブル
(define sekka-kana->roman-alist-long
  `(
    ;; "n" 一つで "nn" を表現する件と被るのでAZIK専用拡張とする(エントリ上書き)
    ("にゃ"      "nya"                                "nga")
    ("にゅ"      "nyu"                                "ngu")
    ("にぇ"      "nye"                                "nge")
    ("にょ"      "nyo"                                "ngo")

    ;; ---以下AZIK---
    ;; ------ AZIK 撥音拡張
    ("かん"       "kz" "kn")
    ("きん"       "kk")
    ("くん"       "kj")
    ("けん"       "kd")
    ("こん"       "kl")
    ("さん"       "sz" "sn")
    ("しん"       "sk")
    ("すん"       "sj")
    ("せん"       "sd")
    ("そん"       "sl")
    ("たん"       "tz" "tn")
    ("ちん"       "tk")
    ("つん"       "tj")
    ("てん"       "td")
    ("とん"       "tl")
    ("なん"       "nz")
    ;;("さん"     "nn")  "ん"になる
    ("にん"       "nk")
    ("ぬん"       "nj")
    ("ねん"       "nd")
    ("のん"       "nl")
    ("はん"       "hz" "hn")
    ("ひん"       "hk")
    ("ふん"       "hj")
    ("へん"       "hd")
    ("ほん"       "hl")
    ("ふぁん"     "fz" "fn")
    ("ふぃん"     "fk")
    ("ふん"       "fj")
    ("ふぇん"     "fd")
    ("ふぉん"     "fl")
    ("まん"       "mz")
    ;;("まん"     "mn") "もの"になる
    ("みん"       "mk")
    ("むん"       "mj")
    ("めん"       "md")
    ("もん"       "ml")
    ("やん"       "yz" "yn")
    ("ゆん"       "yj")
    ("よん"       "yl")
    ("らん"       "rz")
    ("らん"       "rn")
    ("りん"       "rk")
    ("るん"       "rj")
    ("れん"       "rd")
    ("ろん"       "rl" "wz")
    ("わん"       "wn")
    ("うぃん"     "wk")
    ("うぇん"     "wd")
    ("うぉん"     "wl")
        
    ;; ------ AZIK 二重母音拡張
    ("かい"      "kq")
    ("くう"      "kh")
    ("けい"      "kw")
    ("こう"      "kp")
    ("さい"      "sq")
    ("すう"      "sh")
    ("せい"      "sw")
    ("そう"      "sp")
    ("たい"      "tq")
    ("つう"      "th")
    ("てい"      "tw")
    ("とう"      "tp")
    ("ない"      "nq")
    ("ぬう"      "nh")
    ("ねい"      "nw")
    ("のう"      "np")
    ("はい"      "hq")
    ("ふう"      "hh")
    ("へい"      "hw")
    ("ほう"      "hp")
    ("ふぁい"    "fq")
    ("ふう"      "fh")
    ("ふぇい"    "fw")
    ("ふぉー"    "fp")
    ("まい"      "mq")
    ("むう"      "mh")
    ("めい"      "mw")
    ("もう"      "mp")
    ("やい"      "yq")
    ("ゆう"      "yh")
    ("よう"      "yp")
    ("らい"      "rq")
    ("るう"      "rh")
    ("れい"      "rw")
    ("ろう"      "rp")
    ("わい"      "wq")
    ("うぉー"    "wp")
    
    ;; ------ AZIK 濁音、半濁音
    ("がん"       "gz" "gn")
    ("ぎん"       "gg")
    ("ぐん"       "gj")
    ("げん"       "gd")
    ("ごん"       "gl")
    ("ざん"       "zz" "zn")
    ("じん"       "zz")
    ("ずん"       "zj")
    ("ぜん"       "zd")
    ("ぞん"       "zl")
    ("だん"       "dz" "dn")
    ("ぢん"       "dd")
    ("づん"       "dj")
    ("でん"       "dd")
    ("どん"       "dl")
    ("ばん"       "bz" "bn")
    ("びん"       "bb")
    ("ぶん"       "bj")
    ("べん"       "bd")
    ("ぼん"       "bl")
    ("ぱん"       "pz" "pn")
    ("ぴん"       "pp")
    ("ぷん"       "pj")
    ("ぺん"       "pd")
    ("ぽん"       "pl")

    ;; ------ AZIK 濁音、半濁音二重母音拡張
    ("がい"      "kq")
    ("ぐう"      "kh")
    ("げい"      "kw")
    ("ごう"      "kp")
    ("ざい"      "zq" "zv")
    ("ずう"      "zh")
    ("ぜい"      "zw" "zx")
    ("ぞう"      "zp")
    ("だい"      "dq")
    ("づう"      "dh")
    ("でい"      "dw")
    ("どう"      "dp")
    ("ばい"      "bq")
    ("ぶう"      "bh")
    ("べい"      "bw")
    ("ぼう"      "bp")
    ("ぱい"      "pq")
    ("ぷう"      "ph")
    ("ぺい"      "pw")
    ("ぽう"      "pp")

    ;; ------ AZIK 特殊拡張
    ("こと"       "kt")
    ("わた"       "wt")
    ("かも"       "km")
    ("する"       "sr")
    ("られ"       "rr")
    ("ねば"       "nb")
    ("にち"       "nt")

    ("した"       "st")
    ("もの"       "mn")
    ("ため"       "tm")
    ("たら"       "tr")
    ("ざる"       "zr")
    ("びと"       "bt")
    ("だち"       "dt")
    
    ("たち"       "tt")
    ("ます"       "ms")
    ("でも"       "dm")
    ("なる"       "nr")
    ("また"       "mt")
    ("がら"       "gr")
    ("われ"       "wr")

    ("ひと"       "ht")
    ("です"       "ds")
    ("から"       "kr")
    ("よる"       "yr")
    ("たび"       "tb")
    ("ごと"       "gt")
    ))


;; ハッシュテーブル  平仮名   =>ローマ字
(define sekka-kana->roman-hash-short
  (alist->hash-table sekka-kana->roman-alist-short))
(define sekka-kana->roman-hash-long
  (alist->hash-table (append
                      sekka-kana->roman-alist-short
                      sekka-kana->roman-alist-long)))

;; ハッシュテーブル  ローマ字 =>平仮名
(define (sekka-alist-swap alist)
  (append-map
   (lambda (x)
     (let ((hira   (car x))
           (romans (cdr x)))
       (map (lambda (r) (list r hira)) romans)))
   alist))
(define sekka-roman->kana-hash-short
  (alist->hash-table (sekka-alist-swap sekka-kana->roman-alist-short)))
(define sekka-roman->kana-hash-long
  (alist->hash-table (sekka-alist-swap
                      (append
                       sekka-kana->roman-alist-short
                       sekka-kana->roman-alist-long))))

;; 平仮名->カタカナ 変換
(define (gen-hiragana->katakana str)
  (str.tr "あ-んぁぃぅぇぉゃゅょっー" "ア-ンァィゥェォャュョッー"))

;; カタカナ->平仮名 変換
(define (gen-katakana->hiragana str)
  (str.tr "ア-ンァィゥェォャュョッー" "あ-んぁぃぅぇぉゃゅょっー"))

;; カタカナの文字列かどうかを評価する
(define (is-katakana str)
  (if (rxmatch #/^[ア-ンァィゥェォャュョッー]+$/ str) #t #f))

;; 平仮名の文字列かどうかを評価する
(define (is-hiragana str)
  (if (rxmatch #/^[あ-んぁぃぅぇぉゃゅょっー]+$/ str) #t #f))

;; 送り仮名付き平仮名文字列(例:"おこなu") かどうかを評価する
(define (is-hiragana-and-okuri str)
  (if (rxmatch #/^[あ-んぁぃぅぇぉゃゅょっー]+[a-z]$/ str) #t #f))

;; 送り仮名付き漢字文字列(例:"行う") の送り仮名部分を削除する
(define (drop-okuri str)
  (if-let1 m (rxmatch #/^([^あ-んぁぃぅぇぉゃゅょっー]+)(.+)$/ str)
    (rxmatch-substring m 1)
    str))

;; 小文字を大文字にして返す。 "@" も "`" にする
(define (sekka-upcase str)
  (. (str.tr "@" "`") upcase))

;; 大文字を小文字にして返す。 "`" も "@" にする
(define (sekka-downcase str)
  (. (str.tr "`" "@") downcase))

(define (gen-hiragana->roman-pattens-with-hash h hiragana)
  (let1 lst '()
    (let loop ((str hiragana))
      (let ((str1 (str.slice 0 1))
            (str2 (str.slice 0 2))
            (str3 (str.slice 0 3)))
        (cond
         ((eq? 0 (str.size))
          #f)
         ((hash-table-exist? h str3)
          (set! lst (cons (hash-table-get h str3) lst))
          (loop (str.slice (str3.size) (str.size))))
         ((hash-table-exist? h str2)
          (set! lst (cons (hash-table-get h str2) lst))
          (loop (str.slice (str2.size) (str.size))))
         ((hash-table-exist? h str1)
          (set! lst (cons (hash-table-get h str1) lst))
          (loop (str.slice (str1.size) (str.size)))))))
    (reverse lst)))


(define (gen-hiragana->roman-pattens hiragana)
  (delete-duplicates
   (list
    (gen-hiragana->roman-pattens-with-hash  sekka-kana->roman-hash-short  hiragana)
    (gen-hiragana->roman-pattens-with-hash  sekka-kana->roman-hash-long   hiragana))))


;; if failed, return #f
(define (gen-roman->hiragana-with-hash h roman-str)
  (let ((lst '())
        (err #f))
    (let loop ((str roman-str))
      (let ((str1 (str.slice 0 1))
            (str2 (str.slice 0 2))
            (str3 (str.slice 0 3))
            (str4 (str.slice 0 4)))
        (cond
         ((eq? 0 (str.size))
          #f)
         ((hash-table-exist? h str4)
          (set! lst (cons (hash-table-get h str4) lst))
          (loop (str.slice (str4.size) (str.size))))
         ((hash-table-exist? h str3)
          (set! lst (cons (hash-table-get h str3) lst))
          (loop (str.slice (str3.size) (str.size))))
         ((hash-table-exist? h str2)
          (set! lst (cons (hash-table-get h str2) lst))
          (loop (str.slice (str2.size) (str.size))))
         ((hash-table-exist? h str1)
          (set! lst (cons (hash-table-get h str1) lst))
          (loop (str.slice (str1.size) (str.size))))
         (else
          (set! err #t)))))
    (if err
        #f
        (string-join
         (map
          (lambda (x) (car x))
          (reverse lst))))))


;; if failed, return '()
;;   roman-methodには :normal か :azik  を指定します。
;;   それにより、通常のローマ字かAZIK(拡張ローマ字)のどちらを優先するかを指定できます。
(define (gen-roman->hiragana roman-str roman-method)
  (let ((s (gen-roman->hiragana-with-hash  sekka-roman->kana-hash-short  roman-str))
        (l (gen-roman->hiragana-with-hash  sekka-roman->kana-hash-long   roman-str)))
  (delete-duplicates
   (filter
    (lambda (x) x)
    (case roman-method
      ((:azik)
       (list l s))
      ((:normal)
       (list s l))
      (else
       (error "Error: gen-roman->hiragana got illegal roman-method.")))))))


;; if failed, return '()
(define (gen-roman->katakana roman-str roman-method)
  (filter-map
   (lambda (x)
     (gen-hiragana->katakana x))
   (gen-roman->hiragana roman-str roman-method)))

;; This function port from Gauche-0.9's util.combinations.
(define (cartesian-product lol)
  (if (null? lol)
      (list '())
      (let ((l (car lol))
            (rest (cartesian-product (cdr lol))))
        (append-map
         (lambda (x)
           (map (lambda (sub-prod) (cons x sub-prod)) rest))
         l))))


(define (patterns->roman-list patterns)
  (uniq
   (sort
    (append-map
     (lambda (_pattern)
       (map
        (lambda (x)
          (string-join x))
        (cartesian-product _pattern)))
     patterns))))


(define (gen-hiragana->roman-list hiragana)
  (patterns->roman-list 
   (gen-hiragana->roman-pattens hiragana)))
