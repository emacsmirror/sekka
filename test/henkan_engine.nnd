;;-*- mode: nendo; syntax: scheme -*-;;
;;-* encode : utf-8 -*-
;; test for sekka jisyo library

(use nendo.test)
(load "./lib/jisyo-db.nnd")
(load "./lib/convert-jisyo.nnd")
(load "./lib/henkan.nnd")

(define debug-print-length 2000)

(test-start "henkan engine")
;;===================================================================

;;-------------------------------------------------------------------
(test-section "Create jisyo for test suite")

(let ((_input (StringIO.new
               (string-join
                '(
                  "おこなu /行/行な;※送り位置補正/"
                  "へんかん /変換/返還/"
                  "へんか /変化/返歌/"
                  "へんかs /変化/"
                  "しぜんげんご /自然言語/"
                  "しぜんげんごしょり /自然言語処理/"
                  "しぜんげんごりかい /自然言語理解/"
                  "developer /デベロッパー/ディベロッパー/デベロッパ/"
                  "! /！/感嘆符/"
                  ">あん /案/"
                  "{ /｛/"
                  "かっこ /確固/括弧/各個/各戸/確乎/羯鼓;雅楽の打楽器/格好/『/』;二重鉤括弧/【/】;隅付き括弧/［/］;大括弧(bracket)/〔/〕;亀甲括弧/〈/〉;山括弧/《/》;二重山括弧/｛/｝;中括弧(brace)/「/」;鉤括弧/（/）;小括弧,丸括弧(parenthesis)/‘/’;singlequote/“/”;doublequote/『』/【】/［］/〔〕/〈〉/《》/｛｝/「」/（）/‘’/“”/"
                  "こっか /国家;state/国歌;anthem.「-斉唱」/国花/骨化/國家;「国」旧字/黒化/刻下/】/）/］/』/"
                  )
                "\n")))
      (sekka-jisyo-data
       '("okonaU Cおこなu" "oconaU Cおこなu" "おこなu /行/行な;※送り位置補正/" "henkan Cへんかん" "hencan Cへんかん" "へんかん /変換/返還/" "henka Cへんか" "henca Cへんか" "へんか /変化/返歌/" "henkaS Cへんかs" "hencaS Cへんかs" "へんかs /変化/" "shizengengo Cしぜんげんご" "sizengengo Cしぜんげんご" "しぜんげんご /自然言語/" "shizengengoshori Cしぜんげんごしょり" "shizengengosyori Cしぜんげんごしょり" "sizengengoshori Cしぜんげんごしょり" "sizengengosyori Cしぜんげんごしょり" "しぜんげんごしょり /自然言語処理/" "shizengengorikai Cしぜんげんごりかい" "shizengengoricai Cしぜんげんごりかい" "sizengengorikai Cしぜんげんごりかい" "sizengengoricai Cしぜんげんごりかい" "しぜんげんごりかい /自然言語理解/" "developer /デベロッパー/ディベロッパー/デベロッパ/" "! /！/感嘆符/" ">an C>あん" ">あん /案/" "{ /｛/" "kakko Cかっこ" "cakko Cかっこ" "かっこ /確固/括弧/各個/各戸/確乎/羯鼓;雅楽の打楽器/格好/『/』;二重鉤括弧/【/】;隅付き括弧/［/］;大括弧(bracket)/〔/〕;亀甲括弧/〈/〉;山括弧/《/》;二重山括弧/｛/｝;中括弧(brace)/「/」;鉤括弧/（/）;小括弧,丸括弧(parenthesis)/‘/’;singlequote/“/”;doublequote/『』/【】/［］/〔〕/〈〉/《》/｛｝/「」/（）/‘’/“”/" "kokka Cこっか" "cokka Cこっか" "こっか /国家;state/国歌;anthem.「-斉唱」/国花/骨化/國家;「国」旧字/黒化/刻下/】/）/］/』/")))
       
  (test* "Create test jisyo"
         sekka-jisyo-data          
         (convert-skk-jisyo-f _input))

  (let1 sio (StringIO.new (string-join sekka-jisyo-data "\n"))
    (sio.set_encoding "utf-8")
    (load-sekka-jisyo-f sio "./test")))


;;-------------------------------------------------------------------
(test-section "Open the test-suite DB")
(require "kyotocabinet")
(define db (KyotoCabinet::DB.new))
(define a-search (ApproximateSearch.new 0.94))
(test* "DB open"                         #t    (db.open            "./test.kct"))
(test* "DB tune_encoding to utf-8"       #t    (db.tune_encoding   "utf-8"))

;;-------------------------------------------------------------------
(test-section "approximate-search core")

(test* "search keyword list 1"
       '#(#(0.9666666669978037 "henka") #(1.0 "henkan"))
       (a-search.search db "henkan" #f))

(test* "search keyword list 2"
       '#(#(0.9714285717124032 "henkaS"))       
       (a-search.search db "henkanS" #t))

(test* "approximate search 1"
       '((1.0 "henka" "Cへんか") (0.9666666669978037 "henkan" "Cへんかん"))
       (approximate-search db "henka" #f))

(test* "approximate search 2"
       '((0.9666666669978037 "henka" "Cへんか"))
       (approximate-search db "henkaS" #f))


;;-------------------------------------------------------------------
(test-section "henkan (okuri nashi)")

(test* "okuri nashi 1"
       '("変換" "返還" "変化" "返歌")
       (henkan-okuri-nashi db "henkan"))

(test* "okuri nashi 2"
       '("変化" "返歌" "変換" "返還")
       (henkan-okuri-nashi db "henka"))

(test* "okuri nashi 3"
       '("変換" "返還" "変化" "返歌")
       (henkan-okuri-nashi db "henkann"))

(test* "okuri nashi 4"
       '("自然言語")
       (henkan-okuri-nashi db "shizengengo"))

(test* "okuri nashi 5"
       '("自然言語処理" "自然言語")
       (henkan-okuri-nashi db "shizengengosyo"))

(test* "okuri nashi 6"
       '("案")
       (henkan-okuri-nashi db ">an"))

(test* "okuri nashi 7"
       '("案")
       (henkan-okuri-nashi db ">ann"))

(test* "okuri nashi 8"
       '("デベロッパー" "ディベロッパー" "デベロッパ")
       (henkan-okuri-nashi db "developper"))


;;-------------------------------------------------------------------
(test-section "henkan (okuri ari)")


;;-------------------------------------------------------------------
(test-section "henkan kana")


;;(test* "kana 1"
;;       '()
;;       (henkan-kana db "aiueo"))

;;(test* "kana 2"
;;       '()
;;       (henkan-non-kanji db "no"))


;;-------------------------------------------------------------------
(test-section "henkan (non alphabet)")

;;(test* "non-alphabet 1"
;;       '()
;;       (henkan-kana db "{"))


;;===================================================================
(test-end)
