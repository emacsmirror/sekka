;;-*- mode: nendo; syntax: scheme -*-;;
;;-* encode : utf-8 -*-
;; test for sekka jisyo library

(use nendo.test)
(require "./lib/kvs")
(load "./lib/convert-jisyo.nnd")
(load "./lib/henkan.nnd")
(load "./test/common.nnd")

(define dbtype   (string->symbol (first *argv*)))
(define userid   "dummy")
(define userid2  "dummy2")

(test-start "henkan engine")
;;===================================================================

;;-------------------------------------------------------------------
(define target   nil)
(cond
 ((eq? dbtype 'tokyocabinet)
  (set! target "./test.tch"))
 ((eq? dbtype 'memcache)
  (set! target "localhost:11211"))
 (else
  (errorf "Unsupported db type [%s]" (symbol->string dbtype))))


;;-------------------------------------------------------------------
(test-section "Create jisyo for test suite")

(let ((_input (StringIO.new
               (string-join
                '(
                  "わたしh /私/"
                  "おこなu /行/行な;※送り位置補正/"
                  "へんかん /変換/返還/"
                  "へんか /変化/返歌/"
                  "へんかs /変化/"
                  "しぜんげんご /自然言語/"
                  "しぜんげんごしょり /自然言語処理/"
                  "しぜんげんごりかい /自然言語理解/"
                  "developer /デベロッパー/ディベロッパー/デベロッパ/"
                  ">あん /案/"
                  "{ /｛/"
                  "かっこ /確固/括弧/各個/各戸/確乎/羯鼓;雅楽の打楽器/格好/『/』;二重鉤括弧/【/】;隅付き括弧/［/］;大括弧(bracket)/〔/〕;亀甲括弧/〈/〉;山括弧/《/》;二重山括弧/｛/｝;中括弧(brace)/「/」;鉤括弧/（/）;小括弧,丸括弧(parenthesis)/‘/’;singlequote/“/”;doublequote/『』/【】/［］/〔〕/〈〉/《》/｛｝/「」/（）/‘’/“”/"
                  "こっか /国家;state/国歌;anthem.「-斉唱」/国花/骨化/國家;「国」旧字/黒化/刻下/】/）/］/』/"
                  "! /！/感嘆符/"
                  ". /．/・/。/…;.../"
                  "* /＊/※/×/"
                  "? /？/"
                  "/ /／/÷/"
                  "!= /≠/"
                  "こーひー /コーヒー/"
                  "かに /蟹/可児/蠏/"
                  "かんい /簡易/官位/冠位;-十二階/漢医;漢方医/敢為/官医/寛衣/換位/簡意/"
                  "いっち /一致/"
                  "いっち /イッチ/"
                  "えr /得/獲;NB:「とr」と同形/選;NB:「よr」「すぐr」と同形/"
                  "を /小/緒/雄/男/牡/尾/悪/汚/惡;「悪」の旧字(人名用漢字)/"
                  "みr /見/観;(字義:みわたす)/視;(字義:じっとみる)/診;(diagnose) 患者を診る/看;(nurse) 病母を看る/觀;「観」の旧字/"
                  "wake /ウェイク/"
                  "わけ /訳/和気;地名/理由;当て字/分け/分/譯;「訳」の旧字/戯奴/"
                  )
                "\n")))
      (sekka-jisyo-data
       '("watashiH Cわたしh" "watasiH Cわたしh" "わたしh /私" "okonaU Cおこなu" "oconaU Cおこなu" "おこなu /行/行な;※送り位置補正" "hennkann Cへんかん" "hennkan Cへんかん" "henncann Cへんかん" "henncan Cへんかん" "henkann Cへんかん" "henkan Cへんかん" "hencann Cへんかん" "hencan Cへんかん" "へんかん /変換/返還" "hennka Cへんか" "hennca Cへんか" "henka Cへんか" "henca Cへんか" "へんか /変化/返歌" "hennkaS Cへんかs" "henncaS Cへんかs" "henkaS Cへんかs" "hencaS Cへんかs" "へんかs /変化" "shizenngenngo Cしぜんげんご" "shizenngengo Cしぜんげんご" "shizengenngo Cしぜんげんご" "shizengengo Cしぜんげんご" "sizenngenngo Cしぜんげんご" "sizenngengo Cしぜんげんご" "sizengenngo Cしぜんげんご" "sizengengo Cしぜんげんご" "しぜんげんご /自然言語" "shizenngenngoshori Cしぜんげんごしょり" "shizenngenngosyori Cしぜんげんごしょり" "shizenngengoshori Cしぜんげんごしょり" "shizenngengosyori Cしぜんげんごしょり" "shizengenngoshori Cしぜんげんごしょり" "shizengenngosyori Cしぜんげんごしょり" "shizengengoshori Cしぜんげんごしょり" "shizengengosyori Cしぜんげんごしょり" "sizenngenngoshori Cしぜんげんごしょり" "sizenngenngosyori Cしぜんげんごしょり" "sizenngengoshori Cしぜんげんごしょり" "sizenngengosyori Cしぜんげんごしょり" "sizengenngoshori Cしぜんげんごしょり" "sizengenngosyori Cしぜんげんごしょり" "sizengengoshori Cしぜんげんごしょり" "sizengengosyori Cしぜんげんごしょり" "しぜんげんごしょり /自然言語処理" "shizenngenngorikai Cしぜんげんごりかい" "shizenngenngoricai Cしぜんげんごりかい" "shizenngengorikai Cしぜんげんごりかい" "shizenngengoricai Cしぜんげんごりかい" "shizengenngorikai Cしぜんげんごりかい" "shizengenngoricai Cしぜんげんごりかい" "shizengengorikai Cしぜんげんごりかい" "shizengengoricai Cしぜんげんごりかい" "sizenngenngorikai Cしぜんげんごりかい" "sizenngenngoricai Cしぜんげんごりかい" "sizenngengorikai Cしぜんげんごりかい" "sizenngengoricai Cしぜんげんごりかい" "sizengenngorikai Cしぜんげんごりかい" "sizengenngoricai Cしぜんげんごりかい" "sizengengorikai Cしぜんげんごりかい" "sizengengoricai Cしぜんげんごりかい" "しぜんげんごりかい /自然言語理解" "developer /デベロッパー/ディベロッパー/デベロッパ" ">ann C>あん" ">an C>あん" ">あん /案" "{ /｛" "kakko Cかっこ" "cakko Cかっこ" "かっこ /確固/括弧/各個/各戸/確乎/羯鼓;雅楽の打楽器/格好/『/』;二重鉤括弧/【/】;隅付き括弧/［/］;大括弧(bracket)/〔/〕;亀甲括弧/〈/〉;山括弧/《/》;二重山括弧/｛/｝;中括弧(brace)/「/」;鉤括弧/（/）;小括弧,丸括弧(parenthesis)/‘/’;singlequote/“/”;doublequote/『』/【】/［］/〔〕/〈〉/《》/｛｝/「」/（）/‘’/“”" "kokka Cこっか" "cokka Cこっか" "こっか /国家;state/国歌;anthem.「-斉唱」/国花/骨化/國家;「国」旧字/黒化/刻下/】/）/］/』" "! /！/感嘆符" ". /．/・/。/…;..." "* /＊/※/×" "? /？" "/ /／/÷" "!= /≠" "ko-hi- Cこーひー" "ko-hi^ Cこーひー" "ko^hi- Cこーひー" "ko^hi^ Cこーひー" "co-hi- Cこーひー" "co-hi^ Cこーひー" "co^hi- Cこーひー" "co^hi^ Cこーひー" "こーひー /コーヒー" "kani Cかに" "cani Cかに" "かに /蟹/可児/蠏" "kanni Cかんい" "kani Cかんい" "canni Cかんい" "cani Cかんい" "かんい /簡易/官位/冠位;-十二階/漢医;漢方医/敢為/官医/寛衣/換位/簡意" "icchi Cいっち" "ittyi Cいっち" "いっち /一致" "icchi Cいっち" "ittyi Cいっち" "いっち /イッチ" "eR Cえr" "えr /得/獲;NB:「とr」と同形/選;NB:「よr」「すぐr」と同形" "wo Cを" "を /小/緒/雄/男/牡/尾/悪/汚/惡;「悪」の旧字(人名用漢字)" "miR Cみr" "みr /見/観;(字義:みわたす)/視;(字義:じっとみる)/診;(diagnose)" "wake /ウェイク" "wake Cわけ" "wace Cわけ" "わけ /訳/和気;地名/理由;当て字/分け/分/譯;「訳」の旧字/戯奴")
       ))
       
  (test* "Create test jisyo"
         sekka-jisyo-data          
         (convert-skk-jisyo-f _input))

  (test* "default KVS type" 'tokyocabinet (get-kvs-type))

  (set-kvs-type dbtype)
  (test* "changed KVS type" dbtype (get-kvs-type))
  
  (let1 sio (StringIO.new (string-join sekka-jisyo-data "\n"))
    (sio.set_encoding "utf-8")
    (load-sekka-jisyo-f sio target)))


;;-------------------------------------------------------------------
(when (eq? dbtype 'tokyocabinet)
  (require "digest/sha1")
  (test-section "dump db")
  (let1 _output (StringIO.new)
    (_output.set_encoding "utf-8")
    (test* "dump DB to SEKKA jisyo file. (1)"
           "4932dd5ff608c29338882dbf5e87514f55cc7310"
           (begin
             (dump-sekka-jisyo-f _output target)
             (Digest::SHA1.hexdigest (_output.string))
             ;;(_output.string)
             ))))



(test-section "Open the test-suite DB")
(define a-search (ApproximateSearch.new 0.94))
(define kvs      (Kvs.new dbtype))
(cond
 ((eq? dbtype 'tokyocabinet)
  (kvs.open target)
  (require "tokyocabinet"))
 ((eq? dbtype 'memcache)
  (kvs.open target)
  (require "memcache"))
 (else
  (errorf "Unsupported db type [%s]" (symbol->string dbtype))))

(define db (kvs._db))


;;-------------------------------------------------------------------
(test-section "Register User dict")
(for-each
 (lambda (x)
   (let ((_answer    (first x))
         (_user      (second x))
         (_dict-line (third x)))
     (test* (sprintf "register dict [%s] from queue" _dict-line)
            _answer
            (registerUserJisyo _user kvs _dict-line))))
 `(
   (#t  ,userid "まじぱねぇ /マジパネェ/")
   (#t  ,userid "ぶろぐr /ブログ/")
   (#t  ,userid "ぶろぐt /ブログ/")
   (#t  ,userid "へんかんえんじん /変換エンジン/")
   (#t  ,userid "はてぶ /はてブ/はてなブックマーク/")
   (#f  ,userid "はてぶ /はてブ/はてなブックマーク/")
   (#t  ,userid "まじぱねぇ /マジパネェ/まじパネェ/マジ半端ネェ/まじ半端ネェ/")
   (#f  ,userid "まじぱねぇ /マジパネェ/まじパネェ/マジ半端ネェ/まじ半端ネェ/")
   (#f  ,userid "まじぱねぇ /マジパネェ/まじパネェ/マジ半端ネェ/まじ半端ネェ/")
   (#f  ,userid ";; コメント")
   (#f  ,userid ";;-------- 罫線 -------")
   (#f  ,userid "") ;; 空行
   (#f  ,userid "aaaa") ;; 明らかなフォーマットエラー
   (#f  ,userid "単語 /たんご/") ;; フォーマットエラー
   ))


;;-------------------------------------------------------------------
(test-section "simple db fetch")
(test* "db fetch 1"
       "Cへんかん"
       (. (hash-table-get db "MASTER::henkan" #f) force_encoding "UTF-8"))

(test* "db fetch 2"
       "Cかに/かんい"
       (. (hash-table-get db "MASTER::kani" #f) force_encoding "UTF-8"))

(test* "db fetch 3"
       "Cかんい"
       (. (hash-table-get db "MASTER::kanni" #f) force_encoding "UTF-8"))

(test* "db fetch 4"
       #f
       (hash-table-get db "MASTER::aaaa" #f))

(test* "db fetch 5"
       "Cへんかんえんじん"
       (. (hash-table-get db "dummy::henkanenjin" #f) force_encoding "UTF-8"))


;;-------------------------------------------------------------------
(test-section "approximate-search core")

(test* "search keyword list 1"
       '((1.0 "henkan") (0.9714 "henkann") (0.9667 "henka") (0.9611 "hennka"))
       (my-round-map
        (arr->list
         (a-search.search userid kvs "henkan" #f))))

(test* "search keyword list 2"
       '((1.0 "hennkan") (0.975 "hennkann") (0.9714 "hennka") (0.9667 "henkann") (0.9429 "henncan"))
       (my-round-map
        (arr->list
         (a-search.search userid kvs "hennkan" #f))))

(test* "search keyword list 3"
       '((1.0 "henkann") (0.9714 "henkan") (0.9667 "hennkan") (0.9429 "henka"))
       (my-round-map
        (arr->list
         (a-search.search userid kvs "henkann" #f))))

(test* "search keyword list 4"
       '((1.0 "hennkann") (0.975 "hennkan") (0.95 "hennka") (0.95 "henncann"))
       (my-round-map
        (arr->list
         (a-search.search userid kvs "hennkann" #f))))

(test* "search keyword list 5"
       '((0.9714 "henkaS") (0.9667 "hennkaS"))
       (my-round-map
        (arr->list
         (a-search.search userid kvs "henkanS" #t))))

(test* "search keyword list 6"
       '((0.975 "hennkaS") (0.9417 "henkaS"))
       (my-round-map
        (arr->list
         (a-search.search userid kvs "hennkanS" #t))))

(test* "approximate search 1"
       '((1.0 "henka" "Cへんか") (0.9667 "henkan" "Cへんかん") (0.9611 "hennka" "Cへんか") (0.9429 "henkann" "Cへんかん"))
       (my-round-map
        (approximate-search userid kvs "henka" #f)))

(test* "approximate search 2"
       '((1.0 "hennka" "Cへんか") (0.9714 "hennkan" "Cへんかん") (0.9611 "henkan" "Cへんかん") (0.9611 "henka" "Cへんか") (0.95 "hennkann" "Cへんかん"))
       (my-round-map
        (approximate-search userid kvs "hennka" #f)))

(test* "approximate search 3"
       '((0.9667 "henka" "Cへんか"))
       (my-round-map
        (approximate-search userid kvs "henkaS" #f)))

(test* "approximate search 4"
       '((0.9714 "hennka" "Cへんか") (0.9429 "hennkan" "Cへんかん"))
       (my-round-map
        (approximate-search userid kvs "hennkaS" #f)))

(test* "approximate search 5"
       '((1.0 "kani" "Cかに") (1.0 "kani" "Cかんい") (0.9533 "kanni" "Cかんい"))
       (my-round-map
        (approximate-search userid kvs "kani" #f)))


;;-------------------------------------------------------------------
(test-section "henkan (okuri nashi)")

(test* "okuri nashi 1"
       '(("変換" #f "へんかん" j) ("返還" #f "へんかん" j) ("変化" #f "へんか" j) ("返歌" #f "へんか" j))
       (henkan-okuri-nashi userid kvs "henkan"))

(test* "okuri nashi 2"
       '(("変化" #f "へんか" j) ("返歌" #f "へんか" j) ("変換" #f "へんかん" j) ("返還" #f "へんかん" j))
       (henkan-okuri-nashi userid kvs "henka"))

(test* "okuri nashi 3"
       '(("変換" #f "へんかん" j) ("返還" #f "へんかん" j) ("変化" #f "へんか" j) ("返歌" #f "へんか" j))
       (henkan-okuri-nashi userid kvs "henkann"))

(test* "okuri nashi 4"
       '(("変換" #f "へんかん" j) ("返還" #f "へんかん" j) ("変化" #f "へんか" j) ("返歌" #f "へんか" j))
       (henkan-okuri-nashi userid kvs "hennkan"))

(test* "okuri nashi 5"
       '(("変換" #f "へんかん" j) ("返還" #f "へんかん" j) ("変化" #f "へんか" j) ("返歌" #f "へんか" j))
       (henkan-okuri-nashi userid kvs "hennkann"))

(test* "okuri nashi 6"
       '(("自然言語" #f "しぜんげんご" j))
       (henkan-okuri-nashi userid kvs "shizengengo"))

(test* "okuri nashi 7"
       '(("自然言語処理" #f "しぜんげんごしょり" j) ("自然言語" #f "しぜんげんご" j))
       (henkan-okuri-nashi userid kvs "shizengengosyo"))

(test* "okuri nashi 8"
       '(("案" #f ">あん" j))
       (henkan-okuri-nashi userid kvs ">an"))

(test* "okuri nashi 9"
       '(("案" #f ">あん" j))
       (henkan-okuri-nashi userid kvs ">ann"))

(test* "okuri nashi 10"
       '(("デベロッパー" #f "developper" j) ("ディベロッパー" #f "developper" j) ("デベロッパ" #f "developper" j))
       (henkan-okuri-nashi userid kvs "developper"))

(test* "okuri nashi 11"
       '(("蟹" #f "かに" j) ("可児" #f "かに" j) ("蠏" #f "かに" j) ("簡易" #f "かんい" j) ("官位" #f "かんい" j) ("冠位" "-十二階" "かんい" j) ("漢医" "漢方医" "かんい" j) ("敢為" #f "かんい" j) ("官医" #f "かんい" j) ("寛衣" #f "かんい" j) ("換位" #f "かんい" j) ("簡意" #f "かんい" j))
       (henkan-okuri-nashi userid kvs "kani"))

(test* "okuri nashi 12"
       '(("簡易" #f "かんい" j) ("官位" #f "かんい" j) ("冠位" "-十二階" "かんい" j) ("漢医" "漢方医" "かんい" j) ("敢為" #f "かんい" j) ("官医" #f "かんい" j) ("寛衣" #f "かんい" j) ("換位" #f "かんい" j) ("簡意" #f "かんい" j) ("蟹" #f "かに" j) ("可児" #f "かに" j) ("蠏" #f "かに" j))
       (henkan-okuri-nashi userid kvs "kanni"))


;;-------------------------------------------------------------------
(test-section "henkan (okuri ari)")

(test* "approximate search 1"
       '((1.0 "henkaS" "Cへんかs") (0.9667 "hennkaS" "Cへんかs"))
       (my-round-map
        (approximate-search userid kvs "henkaS" #t)))

(test* "approximate search 2"
       '((0.9714 "henkaS" "Cへんかs") (0.9667 "hennkaS" "Cへんかs"))
       (my-round-map
        (approximate-search userid kvs "henkanS" #t)))

(test* "approximate search 3"
       '((1.0 "okonaU" "Cおこなu"))
       (my-round-map
        (approximate-search userid kvs "okonaU" #t)))

(test* "approximate search 4"
       '((0.9667 "okonaU" "Cおこなu"))
       (my-round-map
        (approximate-search userid kvs "okonU" #t)))

(test* "approximate search 5"
       '((1.0 "eR" "Cえr"))
       (my-round-map
        (approximate-search userid kvs "eR" #t)))

(test* "okuri ari 1"
       '(("私は" #f "わたしh" j))
       (henkan-okuri-ari userid kvs "watashiHa"))

(test* "okuri ari 2"
       '(("変化する" #f "へんかs" j))
       (henkan-okuri-ari userid kvs "henkaSuru"))

(test* "okuri ari 3"
       '(("変化する" #f "へんかs" j))
       (henkan-okuri-ari userid kvs "HenkaSuru"))

(test* "okuri ari 4"
       '(("変化する" #f "へんかs" j))
       (henkan-okuri-ari userid kvs "HenkaSURU"))

(test* "okuri ari 5"
       '(("変化する" #f "へんかs" j))
       (henkan-okuri-ari userid kvs "HenkaSuRu"))

(test* "okuri ari 6"
       '(("行う" #f "おこなu" j) ("行なう" "※送り位置補正" "おこなu" j))
       (henkan-okuri-ari userid kvs "okonaU"))

(test* "okuri ari 7"
       '(("行う" #f "おこなu" j) ("行なう" "※送り位置補正" "おこなu" j))
       (henkan-okuri-ari userid kvs "OkonaU"))

(test* "okuri ari 8"
       '(("行う" #f "おこなu" j) ("行なう" "※送り位置補正" "おこなu" j))
       (henkan-okuri-ari userid kvs "okonU"))

(test* "okuri ari 9"
       '(("見る" #f "みr" j) ("観る" "(字義:みわたす)" "みr" j) ("視る" "(字義:じっとみる)" "みr" j) ("診る" "(diagnose)" "みr" j))
       (henkan-okuri-ari userid kvs "miRu"))

(test* "okuri ari 10"
       '(("見" #f "みr" j) ("観" "(字義:みわたす)" "みr" j) ("視" "(字義:じっとみる)" "みr" j) ("診" "(diagnose)" "みr" j))
       (henkan-okuri-ari userid kvs "miR"))

;;-------------------------------------------------------------------
(test-section "henkan hiragana")

(test* "hiragana 1"
       '(("あいうえお" #f "aiueo" h) ("アイウエオ" #f "aiueo" k))
       (henkan-hiragana kvs "aiueo"))

(test* "hiragana 2"
       '(("の" #f "no" h) ("ノ" #f "no" k))
       (henkan-hiragana kvs "no"))

(test* "hiragana 3"
       '(("b" #f "b" j))
       (henkan-hiragana kvs "b"))

(test* "hiragana 4"
       '(("if" #f "if" j))
       (henkan-hiragana kvs "if"))

;;-------------------------------------------------------------------
(test-section "henkan non-kanji")

(test* "non-kanji 1"
       '(("｛" #f "{" j))
       (henkan-non-kanji userid kvs "{"))

(test* "non-kanji 2"
       '(("！" #f "!" j) ("感嘆符" #f "!" j))
       (henkan-non-kanji userid kvs "!"))

(test* "non-kanji 3"
       '(("／" #f "/" j) ("÷" #f "/" j))
       (henkan-non-kanji userid kvs "/"))

(test* "non-kanji 4"
       '(("≠" #f "!=" j))
       (henkan-non-kanji userid kvs "!="))

(test* "non-kanji 5"
       '(("．" #f "." j) ("・" #f "." j) ("。" #f "." j) ("…" "..." "." j))
       (henkan-non-kanji userid kvs "."))


;;-------------------------------------------------------------------
(test-section "sekka henkan toplevel")

(test* "henkan toplevel 1"
       '(("＊" #f "*" j 0) ("※" #f "*" j 1) ("×" #f "*" j 2))
       (sekka-henkan userid kvs "*"))

(test* "henkan toplevel 2"
       '(("しぜんげんごりか" #f "shizengengorika" h 0) ("シゼンゲンゴリカ" #f "shizengengorika" k 1) ("自然言語理解" #f "しぜんげんごりかい" j 2) ("自然言語" #f "しぜんげんご" j 3))
       (sekka-henkan userid kvs "shizengengorika"))

(test* "henkan toplevel 3"
       '(("自然言語理解" #f "しぜんげんごりかい" j 0) ("自然言語" #f "しぜんげんご" j 1) ("しぜんげんごりか" #f "shizengengorika" h 2) ("シゼンゲンゴリカ" #f "shizengengorika" k 3))
       (sekka-henkan userid kvs "Shizengengorika"))

(test* "henkan toplevel 4"
       '(("変化する" #f "へんかs" j 0))
       (sekka-henkan userid kvs "henkaSuru"))

(test* "henkan toplevel 5"
       '(("変換" #f "へんかん" j 0) ("返還" #f "へんかん" j 1) ("変化" #f "へんか" j 2) ("返歌" #f "へんか" j 3) ("へんかん" #f "henkan" h 4) ("ヘンカン" #f "henkan" k 5))
       (sekka-henkan userid kvs "Henkan"))

(test* "henkan toplevel 6"
       '()
       (sekka-henkan userid kvs "HEnkan"))

(test* "henkan toplevel 7"
       '()
       (sekka-henkan userid kvs "HENkan"))

(test* "henkan toplevel 8"
       '(("コーヒー" #f "こーひー" j 0) ("こーひー" #f "ko-hi-" h 1) ("コーヒー" #f "ko-hi-" k 2))
       (sekka-henkan userid kvs "Ko-hi-"))

(test* "henkan toplevel 9"
       '(("得る" #f "えr" j 0) ("獲る" "NB:「とr」と同形" "えr" j 1) ("選る" "NB:「よr」「すぐr」と同形" "えr" j 2))
       (sekka-henkan userid kvs "eRu"))

(test* "henkan toplevel 10"
       '(("得る" #f "えr" j 0) ("獲る" "NB:「とr」と同形" "えr" j 1) ("選る" "NB:「よr」「すぐr」と同形" "えr" j 2))
       (sekka-henkan userid kvs "ERu"))

(test* "henkan toplevel 11"
       '(("を" #f "wo" h 0) ("ヲ" #f "wo" k 1) ("小" #f "を" j 2) ("緒" #f "を" j 3) ("雄" #f "を" j 4) ("男" #f "を" j 5) ("牡" #f "を" j 6) ("尾" #f "を" j 7) ("悪" #f "を" j 8) ("汚" #f "を" j 9) ("惡" "「悪」の旧字(人名用漢字)" "を" j 10))
       (sekka-henkan userid kvs "wo"))

(test* "henkan toplevel 12"
       '()
       (sekka-henkan userid kvs "S"))

(test* "henkan toplevel 13"
       '()
       (sekka-henkan userid kvs "H"))

(test* "henkan toplevel 14"
       '()
       (sekka-henkan userid kvs "gitHuB"))

(test* "henkan toplevel 15"
       '()
       (sekka-henkan userid kvs "ChangeLog"))


(test* "henkan toplevel 16"
       '(("訳" #f "わけ" j 0) ("和気" "地名" "わけ" j 1) ("理由" "当て字" "わけ" j 2) ("分け" #f "わけ" j 3) ("分" #f "わけ" j 4) ("譯" "「訳」の旧字" "わけ" j 5) ("戯奴" #f "わけ" j 6) ("わけ" #f "wake" h 7) ("ワケ" #f "wake" k 8))
       (sekka-henkan userid kvs "Wake"))

(test* "henkan toplevel(for Elisp) 1"
       '(("＊" nil "*" j 0) ("※" nil "*" j 1) ("×" nil "*" j 2))
       (sekkaHenkan userid kvs #f "*"))

(test* "henkan toplevel(for Elisp) 2"
       '(("しぜんげんごりか" nil "shizengengorika" h 0) ("シゼンゲンゴリカ" nil "shizengengorika" k 1) ("自然言語理解" nil "しぜんげんごりかい" j 2) ("自然言語" nil "しぜんげんご" j 3))
       (sekkaHenkan userid kvs #f "shizengengorika"))

(test* "henkan toplevel(for Elisp) 3"
       '(("自然言語理解" nil "しぜんげんごりかい" j 0) ("自然言語" nil "しぜんげんご" j 1) ("しぜんげんごりか" nil "shizengengorika" h 2) ("シゼンゲンゴリカ" nil "shizengengorika" k 3))
       (sekkaHenkan userid kvs #f "Shizengengorika"))

(test* "henkan toplevel(for Elisp) 4"
       '(("変化する" nil "へんかs" j 0))
       (sekkaHenkan userid kvs #f "henkaSuru"))

(test* "henkan toplevel(for Elisp) 5"
       '(("変換" nil "へんかん" j 0) ("返還" nil "へんかん" j 1) ("変化" nil "へんか" j 2) ("返歌" nil "へんか" j 3) ("へんかん" nil "henkan" h 4) ("ヘンカン" nil "henkan" k 5))
       (sekkaHenkan userid kvs #f "Henkan"))

(test* "henkan toplevel(for Elisp) 6"
       '(("マジパネェ" nil "まじぱねぇ" j 0) ("まじパネェ" nil "まじぱねぇ" j 1) ("マジ半端ネェ" nil "まじぱねぇ" j 2) ("まじ半端ネェ" nil "まじぱねぇ" j 3) ("まじぱねえ" nil "majipanee" h 4) ("マジパネエ" nil "majipanee" k 5))
       (sekkaHenkan userid kvs #f "Majipanee"))

(test* "henkan toplevel(for Elisp) 7"
       '(("変換エンジン" nil "へんかんえんじん" j 0) ("変換" nil "へんかん" j 1) ("返還" nil "へんかん" j 2) ("へんかねんじ" nil "henkanenji" h 3) ("ヘンカネンジ" nil "henkanenji" k 4))
       (sekkaHenkan userid kvs #f "Henkanenji"))

(test* "henkan toplevel(for Elisp) 8"
       '(("ブログった" nil "ぶろぐt" j 0))
       (sekkaHenkan userid kvs #f "buroguTta"))

(test* "henkan toplevel(for Elisp) 9"
       '(("ブログりました" nil "ぶろぐt" j 0))
       (sekkaHenkan userid kvs #f "buroguRimashita"))

(test* "henkan toplevel(for Elisp) 10"
       '(("はてブ" nil "はてぶ" j 0) ("はてなブックマーク" nil "はてぶ" j 1) ("はてぶ" nil "hatebu" h 2) ("ハテブ" nil "hatebu" k 3))
       (sekkaHenkan userid kvs #f "Hatebu"))


;;-------------------------------------------------------------------
(test-section "henkan kakutei")
(test* "henkan kakutei(for Elisp) 1"
       '(("返還" nil "へんかん" j 0) ("変換" nil "へんかん" j 1) ("変化" nil "へんか" j 2) ("返歌" nil "へんか" j 3) ("へんかん" nil "henkan" h 4) ("ヘンカン" nil "henkan" k 5))
       (begin
         (sekkaKakutei userid kvs #f "へんかん" "返還")
         (sekkaHenkan userid kvs #f "Henkan")))

(test* "DB check after henkan kakutei 1"
       "/返還/変換"
       (. (hash-table-get db (+ userid "::へんかん") #f) force_encoding "UTF-8"))

(test* "henkan kakutei(for Elisp) 2"
       '(("変換" nil "へんかん" j 0) ("返還" nil "へんかん" j 1) ("変化" nil "へんか" j 2) ("返歌" nil "へんか" j 3) ("へんかん" nil "henkan" h 4) ("ヘンカン" nil "henkan" k 5))
       (begin
         (sekkaKakutei userid kvs #f "へんかん" "変換")
         (sekkaHenkan userid kvs #f "Henkan")))

(test* "DB check after henkan kakutei 2"
       "/変換/返還"
       (. (hash-table-get db (+ userid "::へんかん") #f) force_encoding "UTF-8"))

(test* "henkan kakutei(for Elisp) 3"
       '(("デベロッパ" nil "developer" j 0) ("デベロッパー" nil "developer" j 1) ("ディベロッパー" nil "developer" j 2))
       (begin
         (sekkaKakutei userid kvs #f "developer" "デベロッパ")
         (sekkaHenkan userid kvs #f "developer")))

(test* "henkan kakutei(for Elisp) 4"
       '(("。" nil "." j 0) ("．" nil "." j 1) ("・" nil "." j 2) ("…" "..." "." j 3))
       (begin
         (sekkaKakutei userid kvs #f "." "。")
         (sekkaHenkan userid kvs #f ".")))

(test* "henkan kakutei(for Elisp) 5"
       nil
       (sekkaKakutei userid kvs #f "." "。"))

(test* "henkan kakutei(for Elisp) 6"
       nil
       (sekkaKakutei userid kvs #f "developper" "デベロッパ"))

(test* "henkan kakutei(for Elisp) 7"
       nil
       (sekkaKakutei userid kvs #f "wo" "を"))

(test* "henkan kakutei(for Elisp) 8"
       '(("はてなブックマーク" nil "はてぶ" j 0) ("はてブ" nil "はてぶ" j 1) ("はてぶ" nil "hatebu" h 2) ("ハテブ" nil "hatebu" k 3))
       (begin
         (sekkaKakutei userid kvs #f "はてぶ" "はてなブックマーク")
         (sekkaHenkan userid kvs #f "Hatebu")))


(test* "henkan kakutei(for Elisp) 9"
       '(("．" nil "." j 0) ("・" nil "." j 1) ("。" nil "." j 2) ("…" "..." "." j 3))
       (begin
         (sekkaHenkan userid2 kvs #f ".")))                  ;; userid2

(test* "henkan kakutei(for Elisp) 10"
       '(("。" nil "." j 0) ("．" nil "." j 1) ("・" nil "." j 2) ("…" "..." "." j 3))
       (begin
         (sekkaKakutei userid2 kvs #f "." "。")              ;; userid2
         (sekkaHenkan userid2 kvs #f ".")))                  ;; userid2

(test* "henkan kakutei(for Elisp) 11"
       '(("。" nil "." j 0) ("．" nil "." j 1) ("・" nil "." j 2) ("…" "..." "." j 3))
       (begin
         (sekkaHenkan userid2 kvs #f ".")))                  ;; userid2

(test* "henkan kakutei(for Elisp) 12"
       nil
       (sekkaKakutei userid2 kvs #f "wo" "を"))              ;; userid2


;;===================================================================

;; ---後処理---
;; 最終的な辞書の状態を見たい時、dumpしてみること。
(db.close)
;;(dump-sekka-jisyo-f STDOUT target)

(test-end)
